# 卡尔曼滤波算法

## 从连续系统到离散系统

对于连续时间系统（LTI）：
$$
\begin{cases}\dot{x}(t)=A_cx(t)+B_cu(t)+w_c(t)\\y(t)=C_cx(t)+v_c(t)\end{cases}
$$
其解可表示为：
$$
x(t)=e^{A_ct}x(0)+\int_0^te^{A_c(t-\tau)}B_cu(\tau)\:d\tau+\int_0^te^{A_c(t-\tau)}w_c(\tau)\:d\tau
$$
考虑采样周期 $T$，在离散时间 $k$ 和 $k+1$ 之间积分，得到：
$$
x[(k+1)T]=e^{A_cT}x(kT)+\int_{kT}^{(k+1)T}e^{A_c[(k+1)T-\tau]}B_cu(\tau)\:d\tau+\int_{kT}^{(k+1)T}e^{A_c[(k+1)T-\tau]}w_c(\tau)\:d\tau 
$$
令：
$$
F=e^{A_cT},\quad B=\int_{kT}^{(k+1)T}e^{A_c[(k+1)T-\tau]}B_cu(\tau)\:d\tau
$$
对于控制部分，若假设 $u(τ)$在$[kT,(k+1)T]$内为常数（一般单片机控制系统都是常数），令$s=(k+1)T-\tau$，则$\tau=(k+1)T-s,\:d\tau=-ds$
$$
\begin{aligned}\int_{kT}^{(k+1)T}e^{A_c[(k+1)T-\tau]}B_cu(\tau)\:d\tau&=\left(\int_{kT}^{(k+1)T}e^{A_c[(k+1)T-\tau]}B_c\:d\tau\right)u(kT)\\&=\left(\int_T^0e^{A_cs}B_c\left(-ds\right)\right)u(kT)\\&=\left(\int_0^Te^{A_cs}B_c\:ds\right)u(kT)\end{aligned}
$$
因此，控制项则可化简为：
$$
B=\left(\int_0^Te^{A_c\tau}d\tau\right)B_cu(kT)
$$
**线性化近似**

对 $F$ 和 $B$ 进行泰勒展开近似：
$$
\begin{cases}F=e^{A_cT}\approx I+A_cT+\frac{(A_cT)^2}{2!}+\cdots\\B\approx\left(IT+\frac{A_cT^2}{2!}+\frac{(A_cT)^2}{3!}+\cdots\right)B_c\end{cases}
$$
常用的一阶近似为：
$$
F\approx I+A_cT,\quad B\approx TB_c
$$
因此，得到离散化后的系统
$$
\left\{
\begin{aligned}
x_{k+1} &= F x_k + B_k u_k + w_k \\
z_k    &= H x_k + v_k
\end{aligned}
\right.
$$

## 卡尔曼滤波器及其证明

完整的卡尔曼滤波器的过程模型与量测模型如下：
$$
\mathbf{x}_{k}=F_{k}\mathbf{x}_{k-1}+B_{k}\mathbf{u}_{k-1}+\mathbf{w}_{k-1},\quad\mathbf{w}_{k}\sim N\left(\mathbf{0}_{n\times1},Q_{k}\right) \\
\mathbf{z}_{k}=H_{k}\mathbf{x}_{k}+\mathbf{v}_{k},\quad\mathbf{v}_{k}\sim N\left(\mathbf{0}_{m\times1},R_{k}\right)
$$
其中，$Q$为系统噪声$\mathbf{w}$的协方差矩阵：
$$
\begin{aligned}
\mathrm{Q} & =\mathbf{E}[(\mathbf{w-E}[\mathbf{w}])(\mathbf{w-E}[\mathbf{w}])^T] \\
& =\mathbf{E}[\mathbf{w}\mathbf{w}^T] \\
& =
\begin{bmatrix}
\sigma_{w_1}^2 & \sigma_{w_1}\sigma_{w_2} & \cdots & \sigma_{w_1}\sigma_{w_n} \\
\sigma_{w_2}\sigma_{w_1} & \sigma_{w_2}^2 & \cdots & \sigma_{w_2}\sigma_{w_n} \\
\vdots & \vdots & \ddots & \vdots \\
\sigma_{w_n}\sigma_{w_1} & \sigma_{w_2}\sigma_{w_n} & \cdots & \sigma_{w_n}^2
\end{bmatrix}
\end{aligned}
$$
$R$为测量矩阵$\mathbf{v}$的协方差：
$$
\begin{aligned}
\mathrm{R} & =\mathbf{E}[(\mathbf{v-E}[\mathbf{v}])(\mathbf{v-E}[\mathbf{v}])^{T}] \\
& =\mathbf{E}[\mathbf{v}\mathbf{v}^T] \\
& =
\begin{bmatrix}
\sigma_{v_1}^2 & \sigma_{v_1}\sigma_{v_2} & \cdots & \sigma_{v_1}\sigma_{v_m} \\
\sigma_{v_2}\sigma_{v_1} & \sigma_{v_2}^2 & \cdots & \sigma_{v_2}\sigma_{v_m} \\
\vdots & \vdots & \ddots & \vdots \\
\sigma_{v_m}\sigma_{v_1} & \sigma_{v_2}\sigma_{v_m} & \cdots & \sigma_{v_m}^2
\end{bmatrix}
\end{aligned}
$$

### 递推过程

递推过程为：

> [!Tip] 
>
> **预测步骤**
>
> - **先验状态估计**
>   $$
>   \hat{\mathbf{x}}_{k|k-1}=F_k\hat{\mathbf{x}}_{k-1|k-1}+B_k\mathbf{u}_{k-1}
>   $$
>
> - **先验误差协方差矩阵**
>   $$
>   P_{k|k-1}=F_kP_{k-1|k-1}F_k^T+Q_{k-1}
>   $$
>
> **更新步骤**
>
> - **卡尔曼增益计算**
>   $$
>   K_k=P_{k|k-1}H_k^T(H_kP_{k|k-1}H_k^T+R_k)^{-1}
>   $$
>
> - **后验状态估计**
>   $$
>   \hat{\mathbf{x}}_{k|k}=\hat{\mathbf{x}}_{k|k-1}+K_k(\mathbf{z}_k-H_k\hat{\mathbf{x}}_{k|k-1})
>   $$
>
> - **后验误差协方差矩阵**
>   $$
>   P_{k|k}=(I-K_kH_k)P_{k|k-1}
>   $$

### 目标函数

计算增益的目的是为例使得修正后的$\hat{\mathbf{x}}_{k|k}=\hat{\mathbf{x}}_{k|k-1}+K_k(\mathbf{z}_k-H_k\hat{\mathbf{x}}_{k|k-1})$与真实值的误差$\mathbf{e}_{k|k}=\mathbf{x}_k-\mathbf{\hat{x}}_{k|k}$最小。

假设估计误差$\mathbf{e}_{k|k}$服从正态分布，即$\mathbf{e}_{k|k}\sim N
\begin{pmatrix}
\mathbf{0}_{m\times1},P_{k|k}
\end{pmatrix}$，$P_{k|k}$为估计误差$\mathbf{e}_{k|k}$的方差矩阵
$$
\begin{aligned}
P_{k|k} & =\mathbf{E}[(\mathbf{e}_{k|k}-\mathbf{E}[\mathbf{e}_{k|k}])(\mathbf{e}_{k|k}-\mathbf{E}[\mathbf{e}_{k|k}])^T] \\
& =\mathbf{E}[\mathbf{e}_{k|k}\mathbf{e}_{k|k}^T] \\
& =
\begin{bmatrix}
\sigma_{e_1}^2 & \sigma_{e_1}\sigma_{e_2} & \cdots & \sigma_{e_1}\sigma_{e_n} \\
\sigma_{e_2}\sigma_{e_1} & \sigma_{e_2}^2 & \cdots & \sigma_{e_2}\sigma_{e_n} \\
\vdots & \vdots & \ddots & \vdots \\
\sigma_{e_n}\sigma_{e_1} & \sigma_{e_2}\sigma_{e_n} & \cdots & \sigma_{e_n}^2
\end{bmatrix}
\end{aligned}
$$
如果我们的估计越准确，就意味着估计误差$\mathbf{e}_{k|k}$的方差越小，即矩阵对角元素和越小。所以目标就转变为了求出$K_k$使得$P_{k|k}$矩阵的迹$(tr(P_{k|k})=\sigma_{e_1}^2+\sigma_{e_2}^2+\cdots+\sigma_{e_n}^2)$最小。

即目标函数为
$$
J=\operatorname{tr}(P_{k|k})=\mathbb{E}[e_1^2+e_2^2+\cdots+e_n^2]=\mathbb{E}[\mathbf{e}_{k|k}\mathbf{e}_{k|k}^T]
$$

### 先验误差协方差矩阵证明

> [!Tip]  
>
> **证明：$P_{k|k-1}=F_kP_{k-1|k-1}F_k^T+Q_{k-1}$**
>
> 由于，先验误差协方差矩阵为
> $$
> P_{k|k-1}=\mathbb{E}[\mathbf{e}_{k|k-1}\mathbf{e}_{k|k-1}^T]
> $$
> 其中
> $$
> \begin{aligned}
> \mathbf{e}_{k|k-1}&=\mathbf{x}_k-\hat{\mathbf{x}}_{k|k-1}\\
> &=(F_k\mathbf{x}_{k-1}+\mathbf{w}_{k-1})-F_k\hat{\mathbf{x}}_{k-1|k-1}\\
> &=F_k(\mathbf{x}_{k-1}-\hat{\mathbf{x}}_{k-1|k-1})+\mathbf{w}_{k-1}\\
> &=F_k\mathbf{e}_{k-1|k-1}+\mathbf{w}_{k-1}
> \end{aligned}
> $$
> 其中，$\mathbf{e}_{k-1|k-1}=\mathbf{x}_{k-1}-\hat{\mathbf{x}}_{k-1|k-1}$（在$k-1$时刻的后验估计误差）
>
> $\mathbf{e}_{k|k-1}$带入$P_{k|k-1}$得到
> $$
> \begin{aligned}
> P_{k|k-1}&=\mathbb{E}[\mathbf{e}_{k|k-1}\mathbf{e}_{k|k-1}^T]\\
> &=\mathbb{E}[(F_k\mathbf{e}_{k-1|k-1}+\mathbf{w}_{k-1})(F_k\mathbf{e}_{k-1|k-1}+\mathbf{w}_{k-1})^{T}]\\
> &=\mathbb{E}\left[F_k\mathbf{e}_{k-1|k-1}\mathbf{e}_{k-1|k-1}^TF_k^T+F_k\mathbf{e}_{k-1|k-1}\mathbf{w}_{k-1}^T+\mathbf{w}_{k-1}\mathbf{e}_{k-1|k-1}^TF_k^T+\mathbf{w}_{k-1}\mathbf{w}_{k-1}^T\right]\\
> &=F_k\mathbb{E}\left[\mathbf{e}_{k-1|k-1}\mathbf{e}_{k-1|k-1}^T\right]F_k^T+F_k\mathbb{E}\left[\mathbf{e}_{k-1|k-1}\mathbf{w}_{k-1}^T\right]+\mathbb{E}\left[\mathbf{w}_{k-1}\mathbf{e}_{k-1|k-1}^T\right]F_k^T+\mathbb{E}\left[\mathbf{w}_{k-1}\mathbf{w}_{k-1}^T\right]
> \end{aligned}
> $$
> 其中，$\mathbb{E}\left[\mathbf{e}_{k-1|k-1}\mathbf{e}_{k-1|k-1}^T\right]=P_{k-1|k-1}$，过程噪声协方差$\mathbb{E}\left[\mathbf{w}_{k-1}\mathbf{w}_{k-1}^T\right]=Q_{k-1}$
>
> 同时，在卡尔曼滤波的标准假设中，过程噪声$\mathbf{w}_{k-1}$是白噪声，且与过去的状态估计误差独立，即$\mathbb{E}[\mathbf{e}_{k-1|k-1}\mathbf{w}_{k-1}^T]=\mathbb{E}[\mathbf{e}_{k-1|k-1}\mathbf{w}_{k-1}^T]=\mathbf{0}$，带入得到
> $$
> P_{k|k-1}=F_kP_{k-1|k-1}F_k^T+Q_{k-1}
> $$

### 后验误差协方差矩阵与卡尔曼增益证明

> [!Tip] 
>
> **证明：$P_{k|k}=(I-K_kH_k)P_{k|k-1}$**，其中$K_k=P_{k|k-1}H_k^T(H_kP_{k|k-1}H_k^T+R_k)^{-1}$
>
> 由于，卡尔曼滤波的后验状态估计为$\hat{\mathbf{x}}_{k|k}=\hat{\mathbf{x}}_{k|k-1}+K_k(\mathbf{z}_k-H_k\hat{\mathbf{x}}_{k|k-1})$，(线性反馈)
>
> 而后验误差协方差矩阵定义为：
> $$
> P_{k|k}=\mathbb{E}[\mathbf{e}_{k|k}\mathbf{e}_{k|k}^T]
> $$
> 其中，$\mathbf{e}_{k|k}=\mathbf{x}_k-\hat{\mathbf{x}}_{k|k}$，带入$\hat{\mathbf{x}}_{k|k}$则有
> $$
> \begin{aligned}\mathbf{e}_{k|k}&=\mathbf{x}_{k}-\hat{\mathbf{x}}_{k|k}\\&=\mathbf{x}_{k}-\left[\hat{\mathbf{x}}_{k|k-1}+K_{k}(\mathbf{z}_{k}-H_{k}\hat{\mathbf{x}}_{k|k-1})\right]\end{aligned}
> $$
> 其中，$\mathbf{z}_k=H_k\mathbf{x}_k+\mathbf{v}_k$，带入$\mathbf{e}_{k|k}$进一步得到：
> $$
> \begin{aligned}
> \mathbf{e}_{k|k}&=\mathbf{x}_{k}-\hat{\mathbf{x}}_{k|k-1}-K_{k}(H_{k}\mathbf{x}_{k}+\mathbf{v}_{k}-H_{k}\hat{\mathbf{x}}_{k|k-1})\\
> &=\mathbf{x}_k-\hat{\mathbf{x}}_{k|k-1}-K_kH_k(\mathbf{x}_k-\hat{\mathbf{x}}_{k|k-1})-K_k\mathbf{v}_k\\
> &=(\mathbf{I}-K_kH_k)(\mathbf{x}_k-\hat{\mathbf{x}}_{k|k-1})-K_k\mathbf{v}_k
> \end{aligned}
> $$
> 其中，$\mathbf{e}_{k|k-1}=\mathbf{x}_k-\hat{\mathbf{x}}_{k|k-1}$，因此，进一步的：
> $$
> \mathbf{e}_{k|k}=(I-K_kH_k)\mathbf{e}_{k|k-1}-K_k\mathbf{v}_k
> $$
> 将$\mathbf{e}_{k|k}$带回到先前$P_{k|k}=\mathbb{E}[\mathbf{e}_{k|k}\mathbf{e}_{k|k}^T]$中，则有
> $$
> \begin{aligned}P_{k|k}&=\mathbb{E}[\mathbf{e}_{k|k}\mathbf{e}_{k|k}^T]\\
> &=\mathbb{E}\left[\left((I-K_kH_k)\mathbf{e}_{k|k-1}-K_k\mathbf{v}_k\right)\left((I-K_kH_k)\mathbf{e}_{k|k-1}-K_k\mathbf{v}_k\right)^T\right]\\
> \end{aligned}
> $$
> 展开：
> $$
> \begin{aligned}P_{k|k}&=(I-K_kH_k)\mathbb{E}[\mathbf{e}_{k|k-1}\mathbf{e}_{k|k-1}^T](I-K_kH_k)^T\\&-(I-K_kH_k)\mathbb{E}[\mathbf{e}_{k|k-1}\mathbf{v}_k^T]K_k^T\\&-K_k\mathbb{E}[\mathbf{v}_k\mathbf{e}_{k|k-1}^T](I-K_kH_k)^T\\&+K_k\mathbb{E}[\mathbf{v}_k\mathbf{v}_k^T]K_k^T\end{aligned}
> $$
> 其中，观测协方差矩阵$\mathbb{E}[\mathbf{v}_k\mathbf{v}_k^T]=R$，先验误差$\mathbf{e}_{k|k-1}$与当前观测噪声$\mathbf{v}_k$相互独立（因为$\mathbf{e}_{k|k-1}$依赖于$\mathbf{x}_0,\mathbf{w}_0,\mathbf{w}_1,\ldots,\mathbf{w}_{k-1}$）因此：
> $$
> \mathbb{E}[\mathbf{e}_{k|k-1}\mathbf{v}_k^T]=\mathbb{E}[\mathbf{e}_{k|k-1}]\mathbb{E}[\mathbf{v}_k^T]=\mathbf{0}\\\mathbb{E}[\mathbf{v}_k\mathbf{e}_{k|k-1}^T]=\mathbf{0}
> $$
> 同时，$P_{k|k-1}=\mathbb{E}[\mathbf{e}_{k|k-1}\mathbf{e}_{k|k-1}^T]$（上文已求解），带入得：
> $$
> P_{k|k}=(I-K_kH_k)P_{k|k-1}(I-K_kH_k)^T+K_kR_kK_k^T
> $$
> 展开则有：
> $$
> P_{k|k}=P_{k|k-1}-K_{k}H_{k}P_{k|k-1}-P_{k|k-1}H_{k}^{T}K_{k}^{T}+K_{k}(H_{k}P_{k|k-1}H_{k}^{T}+R_{k})K_{k}^{T}
> $$
> 现在开始求解优化问题，卡尔曼滤波的目标是选择增益$K_k$使得估计误差的方差最小，由于$P_{k|k}$是协方差矩阵，因此目标设为最小化其迹（因为$\operatorname{tr}(P_{k|k})=\sum_{i=1}^{n}\operatorname{Var}(e_{i,k|k})$）：
> $$
> J(K_k)=\mathrm{tr}(P_{k|k})
> $$
>
> > [!important] 
> >
> > 对于迹求导，给出公式
> > $$
> > \frac{\partial\mathrm{tr}(AXB)}{\partial X}=A^TB^T
> > $$
> >
> > $$
> > \frac{\partial\mathrm{tr}(AX^{T})}{\partial X}=A
> > $$
> >
> > $$
> > \frac{\partial\mathrm{tr}(XAX^T)}{\partial X}=2XA
> > $$
>
> 因此，对目标函数求导有：
> $$
> \frac{\partial J}{\partial K_k}=\frac{\partial\mathrm{tr}(P_{k|k})}{\partial K_k}
> $$
> 展开：
> $$
> \begin{aligned}
> \frac{\partial J}{\partial K_k}&=\frac{\partial\mathrm{tr}(P_{k|k})}{\partial K_k}\\
> &=\frac{\partial[\mathrm{tr}(P_{k|k-1})-\mathrm{tr}(KHP_{k|k-1})-\mathrm{tr}(P_{k|k-1}H^TK^T)+\mathrm{tr}(KHP_{k|k-1}H^TK^T)+\mathrm{tr}(KRK^T)]}{\partial K_k}\\
> \end{aligned}
> $$
> 其中
> $$
> \begin{aligned}\frac{\partial\mathrm{tr}(P_{k|k-1})}{\partial K_{k}}&=0\\
> \frac{\partial\mathrm{tr}(K_kH_kP_{k|k-1})}{\partial K_k}&=(H_kP_{k|k-1})^T=P_{k|k-1}^TH_k^T\\
> \frac{\partial\mathrm{tr}(P_{k|k-1}H_k^TK_k^T)}{\partial K_k}&=P_{k|k-1}H_k^T\\
> \frac{\partial\mathrm{tr}(K_kSK_k^T)}{\partial K_k}&=2K_kS,\quad\text{其中 }S=H_kP_{k|k-1}H_k^T+R_k\end{aligned}
> $$
> 同时，$P_{k|k-1}^T=P_{k|k-1}$，因此
> $$
> \begin{aligned}
> \frac{\partial J}{\partial K_k}&=\frac{\partial\mathrm{tr}(P_{k|k})}{\partial K_k}\\
> &=\frac{\partial[\mathrm{tr}(P_{k|k-1})-\mathrm{tr}(KHP_{k|k-1})-\mathrm{tr}(P_{k|k-1}H^TK^T)+\mathrm{tr}(KHP_{k|k-1}H^TK^T)+\mathrm{tr}(KRK^T)]}{\partial K_k}\\
> &=\mathbf{0}-P_{k|k-1}^TH_k^T-P_{k|k-1}H_k^T+2K_k(H_kP_{k|k-1}H_k^T+R_k)\\
> &=-2P_{k|k-1}H_k^T+2K_k(H_kP_{k|k-1}H_k^T+R_k)
> \end{aligned}
> $$
> 令其为0，则$-2P_{k|k-1}H_k^T+2K_k(H_kP_{k|k-1}H_k^T+R_k)=0$，解得：
> $$
> K_k=P_{k|k-1}H_k^T(H_kP_{k|k-1}H_k^T+R_k)^{-1}
> $$
> 将$(H_kP_{k|k-1}H_k^T+R_k)=K^{-1}_kP_{k|k-1}H_k^T$回代到$P_{k|k}=P_{k|k-1}-K_{k}H_{k}P_{k|k-1}-P_{k|k-1}H_{k}^{T}K_{k}^{T}+K_{k}(H_{k}P_{k|k-1}H_{k}^{T}+R_{k})K_{k}^{T}$，则有
> $$
> \begin{aligned}
> P_{k|k}&=P_{k|k-1}-K_{k}H_{k}P_{k|k-1}-P_{k|k-1}H_{k}^{T}K_{k}^{T}+K_{k}(H_{k}P_{k|k-1}H_{k}^{T}+R_{k})K_{k}^{T}\\
> &=P_{k|k-1}-K_{k}H_{k}P_{k|k-1}-P_{k|k-1}H_{k}^{T}K_{k}^{T}+P_{k|k-1}H_k^TK_{k}^{T}\\
> &=(I-K_kH_k)P_{k|k-1}
> \end{aligned}
> $$
> 证毕。